<!DOCTYPE html>
<html lang="en">
  <head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script>
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	item.on('click', '', content, function(e) {
		$(this).addClass('selected');
		$(this).siblings().removeClass('selected');
		e.data.siblings('.content').addClass('hidden');
		e.data.removeClass('hidden');
	});
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

$(addBlockSwitches);    
</script>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Making Services auto-discoverable by the Metrics Service :: AeroGear Mobile Services</title>
    <link rel="canonical" href="https://www.aerogear.org/metrics/latest/making-mobile-services-discoverable-by-metrics.html">
    <meta name="generator" content="Antora 1.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.aerogear.org">AeroGear Mobile Services</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/">Documentation Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">AeroGear SDK</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/android-sdk/latest/index.html">Android</a>
            <a class="navbar-item" href="/ios/latest/index.html">iOS</a>
            <a class="navbar-item" href="/cordova/latest/index.html">Cordova</a>
            <a class="navbar-item" href="/xamarin-sdk/latest/index.html">Xamarin</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Mobile Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/custom/latest/index.html">Custom Runtime Connector</a>
            <a class="navbar-item" href="/push/latest/index.html">Unified Push</a>
            <a class="navbar-item" href="/keycloak/latest/index.html">Auth</a>       
            <a class="navbar-item" href="/metrics/latest/index.html">Metrics</a>
            <a class="navbar-item" href="/build/latest/index.html">CI/CD</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="metrics" data-version="latest">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">AeroGear Metrics Mobile Service</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="provisioning.html">Provisioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="using-mobile-services-dashboard.html">Using the Mobile Services Dashboard</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="using-dashboards.html">Using Dashboards</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="giving-an-openshift-user-access-to-metrics.html">Sharing Access to Dashboards</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="app_metrics_guide.html">Analyzing App Usage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="manually-adding-services-to-metrics.html">Manually Adding Services to Metrics</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="making-mobile-services-discoverable-by-metrics.html">Making Services Discoverable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="keycloak-dashboard.html">Using the Keycloak Dashboard</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">AeroGear Metrics Mobile Service</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">AeroGear</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../aerogear/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Android SDK</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../android-sdk/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear CI/CD Mobile Service</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../build/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Cordova SDK</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cordova/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Custom Runtime Connector Service</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../custom/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear iOS SDK</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ios/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Keycloak Mobile Service</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../keycloak/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">AeroGear Metrics Mobile Service</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Push Mobile Service</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../push/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">AeroGear Xamarin SDK</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../xamarin-sdk/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../../aerogear/latest/index.html" class="home-link"></a>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">AeroGear Metrics Mobile Service</a></li>
    <li class="crumb"><a href="making-mobile-services-discoverable-by-metrics.html">Making Services Discoverable</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/pwright/repos/aerogear/docs/metrics-apb/docs/modules/ROOT/pages/making-mobile-services-discoverable-by-metrics.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Making Services auto-discoverable by the Metrics Service</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Mobile Services that expose a metrics endpoint will already be auto-discovered by the Metrics Service.
No additional steps are needed for Prometheus to poll for metrics from Mobile Services.</p>
</div>
<div class="paragraph">
<p>However, if you would like the Metrics Services to also gather metrics from your own Service, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service has to have one of <code>org.aerogear.metrics/plain_endpoint</code> or
<code>org.aerogear.metrics/ssl_endpoint</code> annotations.</p>
</li>
<li>
<p>Metrics endpoint should have no authentication.</p>
</li>
<li>
<p>Metrics endpoint should be accessible by Prometheus instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Presence of one of the <code>org.aerogear.metrics/plain_endpoint</code> or <code>org.aerogear.metrics/ssl_endpoint</code>
annotations makes the service auto-discoverable.
Value of the annotation will inform metrics service about where to look for metrics data when scraping.</p>
</div>
<div class="paragraph">
<p>For example, if a service is exposing an HTTP metrics endpoint at
<code>/metrics</code>, the annoation would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">org.aerogear.metrics/plain_endpoint: "/metrics"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a service is exposing an HTTPS metrics endpoint at <code>/rest/metrics</code>,
the annoation would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">org.aerogear.metrics/ssl_endpoint: "/rest/metrics"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This endpoint mustn&#8217;t have any authentication currently. This is subject to change in the future.</p>
</div>
<div class="paragraph">
<p>Also, the endpoint should be accessible by the Prometheus instance. There should be a route for the endpoint
that Prometheus can access. As Prometheus is using Kubernetes DNS name, the service needs to be in the same
project as Prometheus. An advanced scenario with separate projects is possible, where the project networks would be linked.</p>
</div>
<div class="paragraph">
<p>More information is available on
<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">Prometheus Kubernetes SD documentation</a>.</p>
</div>
<div class="paragraph">
<p>Here is an example piece of code taken from
<a href="https://github.com/aerogearcatalog/fh-sync-server-apb">FH-Sync Server Ansible Playbook Bundle</a>,
that creates an <code>fh-sync-server</code> service which
is auto-discoverable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">objects:
- apiVersion: v1
  kind: Service
  metadata:
    name: fh-sync-server
    annotations:
      org.aerogear.metrics/plain_endpoint: "/metrics"
    labels:
      ...
  spec:
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another possibility is adding the label after the service is created.</p>
</div>
<div class="paragraph">
<p>An example of doing that with <code>oc</code> CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc annotate service my-awesome-service "org.aerogear.metrics/plain_endpoint"="/metrics"
# OR
oc annotate service my-awesome-service "org.aerogear.metrics/ssl_endpoint"="/metrics"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prometheus constantly monitors Kubernetes and will be notified about this change. It will start collecting the metrics
immediately.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-auto-discovery-works"><a class="anchor" href="#how-auto-discovery-works"></a>How auto-discovery works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As per <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">Prometheus Kubernetes SD documentation</a>,
Prometheus stays synchronized with the cluster state.</p>
</div>
<div class="paragraph">
<p>In this case, it checks the annotations of services and compares them with the annotations that are defined in the Prometheus configuration,
i.e. <code>org.aerogear.metrics/plain_endpoint</code> and <code>org.aerogear.metrics/ssl_endpoint</code>. Once there is a service found with one of those annotations,
the service is picked up as a scrape target and the value of the matched annotation is used as the scrape endpoint path.</p>
</div>
<div class="paragraph">
<p>All of this is done in
<a href="https://github.com/aerogearcatalog/metrics-apb/blob/master/roles/provision-metrics-apb/templates/prometheus-config-map.yml.j2">AeroGear metrics APB</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disable-metrics-scraping"><a class="anchor" href="#disable-metrics-scraping"></a>Disable metrics scraping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you would like to disable metrics scraping for a service, just remove the annotation.
Prometheus will stop collecting the metrics immediately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc annotate service my-awesome-service "org.aerogear.metrics/plain_endpoint"-
# OR
oc annotate service my-awesome-service "org.aerogear.metrics/ssl_endpoint"-</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that Prometheus queries for the metrics from the service might be returning the last value of a metric
for a while. This means, you might see some value in your graphs for a while, even though the annotation was removed
and scraping was stopped.</p>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This is a preview of the https://docs.aerogear.org website.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
